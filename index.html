<!DOCTYPE html>
<html>
<head>
    <title>ç½å®³å¯è¦–åŒ–ãƒãƒƒãƒ— (GPSå¿…é ˆç‰ˆ) - æ©Ÿèƒ½è¿½åŠ ç‰ˆ</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <style>
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; }
        #map { flex-grow: 1; z-index: 1; position: relative; background-color: #eee; }

        /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
        #search-box {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: 90%; max-width: 400px;
            display: flex; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #search-input { flex: 1; padding: 10px; border: none; border-radius: 4px 0 0 4px; font-size: 16px; }
        #search-btn { padding: 10px 20px; background: #0078ff; color: white; border: none; border-radius: 0 4px 4px 0; font-weight: bold; cursor: pointer; }

        /* ç¾åœ¨åœ°ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        #gps-btn {
            position: absolute; bottom: 20px; right: 20px; z-index: 1000;
            background: white; border: 2px solid #ccc; border-radius: 50%;
            width: 50px; height: 50px; cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
            font-size: 24px;
        }
        #gps-btn:active { background: #f0f0f0; }

        /* æŠ•ç¨¿ã‚¨ãƒªã‚¢ */
        #controls {
            padding: 15px; background: #fff; border-top: 1px solid #ddd;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 2;
            max-height: 60vh; overflow-y: auto;
        }
        h3 { margin: 0 0 10px 0; font-size: 16px; color: #333; text-align: center; }
        h4 { margin: 15px 0 10px 0; font-size: 14px; color: #555; }

        .input-group { margin-bottom: 10px; }
        select, input[type="text"] {
            width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box;
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ */
        .file-upload-btn {
            display: block; width: 100%; padding: 12px;
            background-color: #f0f0f0; border: 2px dashed #999; border-radius: 8px;
            text-align: center; cursor: pointer; color: #555; font-weight: bold;
            box-sizing: border-box;
        }
        .file-upload-btn:hover { background-color: #e0e0e0; }
        #fileInput { display: none; }

        /* ãƒ•ã‚¡ã‚¤ãƒ«å–æ¶ˆãƒœã‚¿ãƒ³ */
        #cancelFileBtn {
            display: none; cursor: pointer; margin-left: 10px; color: red; font-weight: bold;
        }

        /* æŠ•ç¨¿ãƒœã‚¿ãƒ³ */
        #submit-btn {
            width: 100%; padding: 12px; background-color: #ff3b30; color: white;
            border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer;
        }
        #submit-btn:active { opacity: 0.8; }
        
        .popup-media { width: 200px; margin-top: 5px; border-radius: 4px; }

        /* æŠ•ç¨¿ä¸€è¦§ãƒªã‚¹ãƒˆ */
        #my-posts-list { list-style: none; padding: 0; margin: 0; }
        #my-posts-list li {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid #eee; font-size: 14px;
        }
        .post-info { flex-grow: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-right: 10px;}
        .delete-post-btn {
            padding: 4px 8px; background-color: #ccc; color: #333; border: none;
            border-radius: 4px; cursor: pointer; font-size: 12px; flex-shrink: 0;
        }
        .delete-post-btn:hover { background-color: #bbb; color: #000;}

    </style>
</head>
<body>

<div id="search-box">
    <input type="text" id="search-input" placeholder="ä½æ‰€ã‚„åœ°åã§æ¤œç´¢ (ä¾‹: æ±äº¬é§…)">
    <button id="search-btn" onclick="searchLocation()">æ¤œç´¢</button>
</div>

<div id="map">
    <button id="gps-btn" onclick="moveToCurrentLocation()">ğŸ§­</button>
</div>

<div id="controls">
    <h3>ğŸ“¸ ç½å®³çŠ¶æ³ã‚’æŠ•ç¨¿ãƒ»å…±æœ‰</h3>
    
    <div class="input-group">
        <label for="fileInput" class="file-upload-btn">
            ğŸ“· å†™çœŸã‚’é¸æŠã¾ãŸã¯æ’®å½±
        </label>
        <input type="file" id="fileInput" accept="image/jpeg" onchange="updateFileName()">
        <div id="fileNameDisplay" style="text-align: center; font-size: 14px; color: #0078ff; margin-top: 5px; font-weight: bold; display: flex; justify-content: center; align-items: center;">
            <span id="fileNameText"></span>
            <span id="cancelFileBtn" onclick="cancelFileUpload()">Ã— å–æ¶ˆ</span>
        </div>
    </div>
    
    <div class="input-group">
        <select id="categoryInput">
            <option value="" disabled selected>ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="flooding">ğŸŒŠ æµ¸æ°´ãƒ»å† æ°´</option>
            <option value="fire">ğŸ”¥ ç«ç½</option>
            <option value="collapse">ğŸšï¸ å»ºç‰©å€’å£Š</option>
            <option value="landslide">â›°ï¸ åœŸç ‚å´©ã‚Œ</option>
            <option value="road_damage">ğŸš§ é“è·¯å¯¸æ–­ãƒ»é™¥æ²¡</option>
            <option value="infrastructure_damage">âš¡ é›»æŸ±ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©è¢«å®³</option>
            <option value="supply_water">ğŸ’§ çµ¦æ°´æ‰€æƒ…å ±</option>
            <option value="supply_food">ğŸ™ æ”¯æ´ç‰©è³‡ãƒ»ç‚Šãå‡ºã—</option>
            <option value="rescue">ğŸ†˜ æ•‘åŠ©è¦è«‹</option>
            <option value="other">âšª ãã®ä»–</option>
        </select>
    </div>

    <div class="input-group">
        <input type="text" id="textInput" placeholder="çŠ¶æ³ã®èª¬æ˜ (ä»»æ„)">
    </div>

    <button id="submit-btn" onclick="processImage()">åœ°å›³ã«è¿½åŠ  & ä¿å­˜</button>

    <div id="my-posts-container" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
        <h4>ğŸ—‚ï¸ è‡ªåˆ†ã®æŠ•ç¨¿ä¸€è¦§</h4>
        <ul id="my-posts-list">
            </ul>
        <div style="text-align: center; margin-top: 10px;">
            <button onclick="clearLocalStorage()" style="font-size: 12px; color: #888; background: none; border: none; text-decoration: underline;">å…¨ä»¶å‰Šé™¤</button>
        </div>
    </div>
</div>

<script>
    // --- 1. åœ°å›³ã®åˆæœŸåŒ– ---
    var map = L.map('map'); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    var localPins = [];
    var markersById = {}; 
    var currentLocationMarker = null;

    // --- 2. èµ·å‹•æ™‚ã®å‡¦ç† ---
    window.onload = function() {
        loadFromLocalStorage();
        moveToCurrentLocation();
    };

    // --- ç¾åœ¨åœ°ã¸ç§»å‹• ---
    function moveToCurrentLocation() {
        if (!navigator.geolocation) {
            alert("ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å ´æ‰€ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚");
            map.setView([35.681, 139.767], 5);
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                var lat = position.coords.latitude;
                var lon = position.coords.longitude;
                map.setView([lat, lon], 16);

                if (currentLocationMarker) map.removeLayer(currentLocationMarker);
                currentLocationMarker = L.circleMarker([lat, lon], {
                    radius: 8, color: "white", weight: 2, fillColor: "#2196F3", fillOpacity: 1
                }).addTo(map).bindPopup("ç¾åœ¨åœ°");
            },
            (error) => {
                console.log("ç¾åœ¨åœ°å–å¾—ã‚¨ãƒ©ãƒ¼: " + error.message);
                map.setView([35.681, 139.767], 5);
            }
        );
    }

    // --- 3. ä½æ‰€æ¤œç´¢ ---
    function searchLocation() {
        var query = document.getElementById('search-input').value;
        if (!query) return;

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    map.setView([data[0].lat, data[0].lon], 16);
                } else {
                    alert("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
                }
            })
            .catch(e => alert("æ¤œç´¢ã‚¨ãƒ©ãƒ¼"));
    }

    // --- 4. ç”»åƒå‡¦ç† ---
    function processImage() {
        var fileInput = document.getElementById('fileInput');
        var file = fileInput.files[0];
        var category = document.getElementById('categoryInput').value;
        var text = document.getElementById('textInput').value;

        if (!file) { alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
        if (!category) { alert("ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

        // Exifèª­ã¿å–ã‚Šé–‹å§‹
        EXIF.getData(file, function() {
            var latData = EXIF.getTag(this, "GPSLatitude");
            var lonData = EXIF.getTag(this, "GPSLongitude");

            if (latData && lonData) {
                var latRef = EXIF.getTag(this, "GPSLatitudeRef");
                var lonRef = EXIF.getTag(this, "GPSLongitudeRef");
                
                var lat = convertDMSToDD(latData[0], latData[1], latData[2], latRef);
                var lon = convertDMSToDD(lonData[0], lonData[1], lonData[2], lonRef);
                var imageUrl = URL.createObjectURL(file);

                var newPin = {
                    id: Date.now(),
                    lat: lat, lon: lon, category: category, text: text, media_url: imageUrl 
                };

                addPinToMap(newPin);
                saveToLocalStorage(newPin);
                map.setView([lat, lon], 16);
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                cancelFileUpload(); 
                document.getElementById('textInput').value = "";
                document.getElementById('categoryInput').selectedIndex = 0; 
                alert("æŠ•ç¨¿ã—ã¾ã—ãŸï¼");

            } else {
                alert("âš ï¸ æŠ•ç¨¿ã§ãã¾ã›ã‚“\n\nã“ã®å†™çœŸã«ã¯ä½ç½®æƒ…å ±(GPS)ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nä½ç½®æƒ…å ±ã‚’ONã«ã—ã¦æ’®å½±ã—ãŸå†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                cancelFileUpload(); 
            }
        });
    }

    function convertDMSToDD(degrees, minutes, seconds, direction) {
        var dd = degrees + minutes / 60 + seconds / (60 * 60);
        if (direction == "S" || direction == "W") dd = dd * -1;
        return dd;
    }

    // --- 5. ãƒ”ãƒ³æç”» ---
    function addPinToMap(data) {
        var color = "gray"; 
        if (data.category === "flooding") color = "blue";
        else if (data.category === "fire") color = "red";
        else if (data.category === "collapse") color = "brown";
        else if (data.category === "landslide") color = "saddlebrown";
        else if (data.category === "road_damage") color = "black";
        else if (data.category === "infrastructure_damage") color = "purple";
        else if (data.category === "supply_water") color = "cyan";
        else if (data.category === "supply_food") color = "green";
        else if (data.category === "rescue") color = "orange";
        // else if (data.category === "other") color = "gray";

        var pinOptions = { radius: 10, fillColor: color, color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.9 };

        var popupContent = `<b>${getCategoryLabel(data.category)}</b><br>${data.text}<br>`;
        if (data.media_url) {
            if(data.media_url.startsWith('http') || data.media_url.startsWith('blob')) {
                 popupContent += `<img src="${data.media_url}" width="200" style="margin-top:5px; border-radius:4px;">`;
            }
        }

        var marker = L.circleMarker([data.lat, data.lon], pinOptions)
            .addTo(map)
            .bindPopup(popupContent);

        if (data.id) {
            markersById[data.id] = marker;
        }
    }

    function getCategoryLabel(key) {
        const labels = {
            "flooding": "ğŸŒŠ æµ¸æ°´", "fire": "ğŸ”¥ ç«ç½", "collapse": "ğŸšï¸ å€’å£Š",
            "landslide": "â›°ï¸ åœŸç ‚å´©ã‚Œ", "road_damage": "ğŸš§ é“è·¯å¯¸æ–­", 
            "infrastructure_damage": "âš¡ ã‚¤ãƒ³ãƒ•ãƒ©è¢«å®³", "supply_water": "ğŸ’§ çµ¦æ°´æ‰€",
            "supply_food": "ğŸ™ æ”¯æ´ç‰©è³‡", "rescue": "ğŸ†˜ æ•‘åŠ©è¦è«‹",
            "other": "âšª ãã®ä»–"
        };
        return labels[key] || key;
    }

    // --- 6. ä¿å­˜ã¨ç®¡ç† ---
    function saveToLocalStorage(pinData) {
        var saveItem = {
            id: pinData.id,
            lat: pinData.lat,
            lon: pinData.lon,
            category: pinData.category,
            text: pinData.text,
            media_url: "" 
        };
        localPins.push(saveItem);
        localStorage.setItem('disasterMapData', JSON.stringify(localPins));
        renderPostList();
    }

    function loadFromLocalStorage() {
        var dataStr = localStorage.getItem('disasterMapData');
        if (dataStr) {
            localPins = JSON.parse(dataStr);
            localPins.forEach(pin => {
                if(!pin.id) pin.id = Date.now() + Math.random();
                addPinToMap(pin)
            });
            renderPostList();
        }
    }

    function renderPostList() {
        var listEl = document.getElementById('my-posts-list');
        listEl.innerHTML = ""; 

        if (localPins.length === 0) {
            listEl.innerHTML = "<li style='color:#888;'>ã¾ã æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“</li>";
            return;
        }

        localPins.slice().reverse().forEach(pin => {
            var li = document.createElement('li');
            var catLabel = getCategoryLabel(pin.category);
            var textPreview = pin.text ? pin.text : "(èª¬æ˜ãªã—)";
            
            li.innerHTML = `
                <div class="post-info">
                    <b>${catLabel}</b>: ${textPreview}
                </div>
                <button class="delete-post-btn" onclick="deletePost(${pin.id})">å‰Šé™¤</button>
            `;
            listEl.appendChild(li);
        });
    }

    function deletePost(id) {
        if(!confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nåœ°å›³ã‹ã‚‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚")) return;

        localPins = localPins.filter(pin => pin.id !== id);
        
        localStorage.setItem('disasterMapData', JSON.stringify(localPins));
        
        if (markersById[id]) {
            map.removeLayer(markersById[id]);
            delete markersById[id];
        }

        renderPostList();
    }

    function clearLocalStorage() {
        if(confirm("ä¿å­˜ã•ã‚Œã¦ã„ã‚‹æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’ã€å…¨ã¦ã€‘å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) {
            localStorage.removeItem('disasterMapData');
            localPins = [];
            markersById = {};
            alert("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
            location.reload();
        }
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«åè¡¨ç¤ºã¨å–æ¶ˆ ---
    function cancelFileUpload() {
        document.getElementById('fileInput').value = "";
        updateFileName();
    }

    function updateFileName() {
        var input = document.getElementById('fileInput');
        var textDisplay = document.getElementById('fileNameText');
        var cancelBtn = document.getElementById('cancelFileBtn');
        
        if(input.files.length > 0) {
            // ãƒ•ã‚¡ã‚¤ãƒ«åã¯è¡¨ç¤ºã›ãšã€é¸æŠä¸­ã§ã‚ã‚‹ã“ã¨ã ã‘ã‚’ç¤ºã™
            textDisplay.innerHTML = "âœ… <b>å†™çœŸé¸æŠä¸­</b>";
            cancelBtn.style.display = "inline"; 
        } else {
            textDisplay.textContent = "";
            cancelBtn.style.display = "none";
        }
    }
</script>

</body>
</html>